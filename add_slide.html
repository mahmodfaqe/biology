<!DOCTYPE html>
<html lang="{{ lang_code }}" dir="{{ 'rtl' if lang_code == 'ckb' else 'ltr' }}">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>{{ t.site_title }} - {% if slide %}Edit{% else %}Add{% endif %} Study Material</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #1e40af;
            --secondary-teal: #0891b2;
            --accent-emerald: #059669;
            --warm-gold: #f59e0b;
            --light-gray: #f8fafc;
            --dark-text: #1e293b;
            --medium-gray: #64748b;
            --success-green: #10b981;
            --error-red: #ef4444;
        }

        body {
            font-family: 'Segoe UI', 'Tahoma', 'Geneva', 'Verdana', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
            color: var(--dark-text);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Page Header */
        .page-header {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .page-title {
            font-size: 2.5rem;
            color: var(--dark-text);
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-subtitle {
            color: var(--medium-gray);
            font-size: 1.1rem;
        }

        /* Form Container */
        .form-container {
            background: white;
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .form-grid {
            display: grid;
            gap: 2rem;
        }

        .form-section {
            border-left: 4px solid var(--primary-blue);
            padding-left: 1.5rem;
        }

        .section-title {
            font-size: 1.3rem;
            color: var(--dark-text);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 600;
            color: var(--dark-text);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .required {
            color: var(--error-red);
        }

        .form-input,
        .form-textarea,
        .form-select {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            color: var(--dark-text);
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
            line-height: 1.6;
        }

        .form-textarea.large {
            min-height: 200px;
        }

        /* Character Counter */
        .char-counter {
            font-size: 0.85rem;
            color: var(--medium-gray);
            text-align: right;
            margin-top: 0.25rem;
        }

        /* Help Text */
        .help-text {
            font-size: 0.85rem;
            color: var(--medium-gray);
            margin-top: 0.25rem;
            line-height: 1.4;
        }

        /* Flash Messages */
        .flash-messages {
            margin-bottom: 2rem;
        }

        .flash-message {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
        }

        .flash-message.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-red);
            border-left: 4px solid var(--error-red);
        }

        .flash-message.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-green);
            border-left: 4px solid var(--success-green);
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 1rem;
            min-width: 140px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-teal));
            color: white;
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-green), var(--accent-emerald));
            color: white;
        }

        .btn-secondary {
            background: var(--light-gray);
            color: var(--medium-gray);
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
            color: var(--dark-text);
        }

        /* Loading State */
        .btn.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .btn.loading::after {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Preview Section */
        .preview-section {
            background: var(--light-gray);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .preview-title {
            font-size: 1.2rem;
            color: var(--dark-text);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .preview-content {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        /* RTL Support */
        [dir="rtl"] .form-section {
            border-left: none;
            border-right: 4px solid var(--primary-blue);
            padding-left: 0;
            padding-right: 1.5rem;
        }

        [dir="rtl"] .char-counter {
            text-align: left;
        }

        [dir="rtl"] .form-actions {
            justify-content: flex-start;
        }

        [dir="rtl"] .flash-message {
            border-left: none;
            border-right: 4px solid;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .form-container {
                padding: 1.5rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .form-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .page-header {
                padding: 1.5rem;
            }

            .form-container {
                padding: 1rem;
            }

            .page-title {
                font-size: 1.8rem;
            }

            .section-title {
                font-size: 1.1rem;
            }

            .form-section {
                padding-left: 1rem;
            }

            [dir="rtl"] .form-section {
                padding-right: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-message {{ category }}">
                            <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'error' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                            <span>{{ message }}</span>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-{% if slide %}edit{% else %}plus-circle{% endif %}"></i>
                {% if slide %}
                    {% if lang == 'ckb' %}Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒÚ©Ø±Ø¯Ù†ÛŒ Ú©Û•Ø±Û•Ø³ØªÛ•ÛŒ Ø®ÙˆÛÙ†Ø¯Ù†{% else %}Edit Study Material{% endif %}
                {% else %}
                    {% if lang == 'ckb' %}Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ú©Û•Ø±Û•Ø³ØªÛ•ÛŒ Ø®ÙˆÛÙ†Ø¯Ù†{% else %}Add Study Material{% endif %}
                {% endif %}
            </h1>
            <p class="page-subtitle">
                {% if lang == 'ckb' %}
                    Ú©Û•Ø±Û•Ø³ØªÛ•ÛŒ Ø®ÙˆÛÙ†Ø¯Ù†ÛŒ Ú©ÙˆØ§Ù„ÛŒØªÛŒ Ø¨Û† Ù‚ÙˆØªØ§Ø¨ÛŒØ§Ù† Ø¯Ø±ÙˆØ³Øª Ø¨Ú©Û•
                {% else %}
                    Create quality study materials for students
                {% endif %}
            </p>
        </div>

        <!-- Form Container -->
        <div class="form-container">
            <form method="POST" id="slideForm">
                <div class="form-grid">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-info-circle"></i>
                            {% if lang == 'ckb' %}Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ø³Û•Ø±Û•Ú©ÛŒ{% else %}Basic Information{% endif %}
                        </h3>

                        <!-- Chapter Selection -->
                        {% if not slide %}
                        <div class="form-group">
                            <label for="chapter_id" class="form-label">
                                <i class="fas fa-book"></i>
                                {% if lang == 'ckb' %}Ø¨Ø§Ø¨Û•Øª{% else %}Chapter{% endif %} <span class="required">*</span>
                            </label>
                            <select name="chapter_id" id="chapter_id" class="form-select" required>
                                <option value="">{% if lang == 'ckb' %}Ø¨Ø§Ø¨Û•ØªÛÚ© Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•{% else %}Select a chapter{% endif %}</option>
                                {% for chapter in chapters %}
                                <option value="{{ chapter.id }}"
                                        {% if request.args.get('chapter_id') == chapter.id|string %}selected{% endif %}>
                                    {{ chapter.order }}. {{ chapter.get_title(lang) }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        <div class="form-row">
                            <!-- Order -->
                            <div class="form-group">
                                <label for="order" class="form-label">
                                    <i class="fas fa-sort-numeric-up"></i>
                                    {% if lang == 'ckb' %}Ú˜Ù…Ø§Ø±Û•ÛŒ Ú•ÛŒØ²Ø¨Û•Ù†Ø¯ÛŒ{% else %}Order Number{% endif %} <span class="required">*</span>
                                </label>
                                <input type="number" name="order" id="order" class="form-input"
                                       value="{{ slide.order if slide else '1' }}" min="1" required>
                                <div class="help-text">
                                    {% if lang == 'ckb' %}Ú˜Ù…Ø§Ø±Û•ÛŒ Ú•ÛŒØ²Ø¨Û•Ù†Ø¯ÛŒ Ø¦Û•Ù… Ú©Û•Ø±Û•Ø³ØªÛ•ÛŒÛ• Ù„Û• Ù†ÛÙˆ Ø¨Ø§Ø¨Û•ØªÛ•Ú©Û•Ø¯Ø§{% else %}The order number of this material within the chapter{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content in English -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-globe"></i>
                            {% if lang == 'ckb' %}Ù†Ø§ÙˆÛ•Ú•Û†Ú© Ø¨Û• Ø¦ÛŒÙ†Ú¯Ù„ÛŒØ²ÛŒ{% else %}Content in English{% endif %}
                        </h3>

                        <div class="form-group">
                            <label for="title_en" class="form-label">
                                <i class="fas fa-heading"></i>
                                {% if lang == 'ckb' %}Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù† Ø¨Û• Ø¦ÛŒÙ†Ú¯Ù„ÛŒØ²ÛŒ{% else %}Title in English{% endif %} <span class="required">*</span>
                            </label>
                            <input type="text" name="title_en" id="title_en" class="form-input"
                                   value="{{ slide.title_en if slide else '' }}"
                                   maxlength="200" required>
                            <div class="char-counter" data-for="title_en">0/200</div>
                        </div>

                        <div class="form-group">
                            <label for="content_en" class="form-label">
                                <i class="fas fa-paragraph"></i>
                                {% if lang == 'ckb' %}Ù†Ø§ÙˆÛ•Ú•Û†Ú© Ø¨Û• Ø¦ÛŒÙ†Ú¯Ù„ÛŒØ²ÛŒ{% else %}Content in English{% endif %} <span class="required">*</span>
                            </label>
                            <textarea name="content_en" id="content_en" class="form-textarea large" required>{{ slide.content_en if slide else '' }}</textarea>
                            <div class="help-text">
                                {% if lang == 'ckb' %}Ú•ÙˆÙˆÙ†Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ ØªÛ•ÙˆØ§Ùˆ Ùˆ ÙˆØ±Ø¯ Ø¨Ù†ÙˆÙˆØ³Û•{% else %}Write detailed and comprehensive explanation{% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Content in Kurdish -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-language"></i>
                            {% if lang == 'ckb' %}Ù†Ø§ÙˆÛ•Ú•Û†Ú© Ø¨Û• Ú©ÙˆØ±Ø¯ÛŒ{% else %}Content in Kurdish{% endif %}
                        </h3>

                        <div class="form-group">
                            <label for="title_ckb" class="form-label">
                                <i class="fas fa-heading"></i>
                                {% if lang == 'ckb' %}Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù† Ø¨Û• Ú©ÙˆØ±Ø¯ÛŒ{% else %}Title in Kurdish{% endif %} <span class="required">*</span>
                            </label>
                            <input type="text" name="title_ckb" id="title_ckb" class="form-input"
                                   value="{{ slide.title_ckb if slide else '' }}"
                                   maxlength="200" required>
                            <div class="char-counter" data-for="title_ckb">0/200</div>
                        </div>

                        <div class="form-group">
                            <label for="content_ckb" class="form-label">
                                <i class="fas fa-paragraph"></i>
                                {% if lang == 'ckb' %}Ù†Ø§ÙˆÛ•Ú•Û†Ú© Ø¨Û• Ú©ÙˆØ±Ø¯ÛŒ{% else %}Content in Kurdish{% endif %} <span class="required">*</span>
                            </label>
                            <textarea name="content_ckb" id="content_ckb" class="form-textarea large" required>{{ slide.content_ckb if slide else '' }}</textarea>
                        </div>
                    </div>

                    <!-- Additional Details -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-clipboard-list"></i>
                            {% if lang == 'ckb' %}Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ø²ÛŒØ§ØªØ±{% else %}Additional Details{% endif %}
                        </h3>

                        <div class="form-group">
                            <label for="image_url" class="form-label">
                                <i class="fas fa-image"></i>
                                {% if lang == 'ckb' %}Ø¨Û•Ø³ØªÛ•Ø±ÛŒ ÙˆÛÙ†Û•{% else %}Image URL{% endif %}
                            </label>
                            <input type="url" name="image_url" id="image_url" class="form-input"
                                   value="{{ slide.image_url if slide else '' }}"
                                   placeholder="https://example.com/image.jpg">
                            <div class="help-text">
                                {% if lang == 'ckb' %}Ø¨Û•Ø³ØªÛ•Ø±ÛŒ ÙˆÛÙ†Û•ÛŒÛ•Ú© Ú©Û• Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ Ø¨Û• Ø¨Ø§Ø¨Û•ØªÛ•Ú©Û•ÙˆÛ• Ù‡Û•ÛŒÛ•{% else %}URL of an image related to this topic{% endif %}
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="location" class="form-label">
                                    <i class="fas fa-map-marker-alt"></i>
                                    {% if lang == 'ckb' %}Ø´ÙˆÛÙ†{% else %}Location{% endif %}
                                </label>
                                <input type="text" name="location" id="location" class="form-input"
                                       value="{{ slide.location if slide else '' }}"
                                       placeholder="{% if lang == 'ckb' %}Ù„Û• Ú©ÙˆÛ Ø¯Û•Ø¯Û†Ø²Ø±ÛØªÛ•ÙˆÛ•ØŸ{% else %}Where is it found?{% endif %}">
                            </div>

                            <div class="form-group">
                                <label for="functions" class="form-label">
                                    <i class="fas fa-cogs"></i>
                                    {% if lang == 'ckb' %}Ú©Ø§Ø±Û•Ú©Ø§Ù†{% else %}Functions{% endif %}
                                </label>
                                <input type="text" name="functions" id="functions" class="form-input"
                                       value="{{ slide.functions if slide else '' }}"
                                       placeholder="{% if lang == 'ckb' %}Ú†ÛŒ Ø¯Û•Ú©Ø§ØªØŸ{% else %}What does it do?{% endif %}">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="components" class="form-label">
                                <i class="fas fa-puzzle-piece"></i>
                                {% if lang == 'ckb' %}Ù¾ÛÚ©Ù‡Ø§ØªÛ•Ú©Ø§Ù†{% else %}Components{% endif %}
                            </label>
                            <textarea name="components" id="components" class="form-textarea">{{ slide.components if slide else '' }}</textarea>
                            <div class="help-text">
                                {% if lang == 'ckb' %}Ù¾ÛÚ©Ù‡Ø§ØªÛ• Ø³Û•Ø±Û•Ú©ÛŒÛ•Ú©Ø§Ù† Ú†ÛŒÙ†ØŸ{% else %}What are the main components?{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-save"></i>
                        {% if slide %}
                            {% if lang == 'ckb' %}Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•{% else %}Update{% endif %}
                        {% else %}
                            {% if lang == 'ckb' %}Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†{% else %}Add{% endif %}
                        {% endif %}
                    </button>

                    <a href="{% if slide %}{{ url_for('manage_slides', lang=lang, chapter_id=slide.chapter_id) }}{% else %}{{ url_for('admin_dashboard', lang=lang) }}{% endif %}"
                       class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        {% if lang == 'ckb' %}Ù¾Ø§Ø´Ú¯Û•Ø²Ø¨ÙˆÙˆÙ†Û•ÙˆÛ•{% else %}Cancel{% endif %}
                    </a>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Character counters
            const counters = document.querySelectorAll('.char-counter[data-for]');
            counters.forEach(counter => {
                const inputId = counter.getAttribute('data-for');
                const input = document.getElementById(inputId);
                if (input) {
                    function updateCounter() {
                        const length = input.value.length;
                        const maxLength = input.getAttribute('maxlength') || 'âˆ';
                        counter.textContent = `${length}/${maxLength}`;

                        // Color coding
                        if (maxLength !== 'âˆ') {
                            const percentage = length / parseInt(maxLength);
                            if (percentage > 0.9) {
                                counter.style.color = 'var(--error-red)';
                            } else if (percentage > 0.7) {
                                counter.style.color = 'var(--warning-orange)';
                            } else {
                                counter.style.color = 'var(--medium-gray)';
                            }
                        }
                    }

                    input.addEventListener('input', updateCounter);
                    updateCounter(); // Initial count
                }
            });

            // Form validation
            const form = document.getElementById('slideForm');
            const submitBtn = document.getElementById('submitBtn');

            form.addEventListener('submit', function(e) {
                // Add loading state
                submitBtn.classList.add('loading');
                submitBtn.disabled = true;

                // Basic validation
                const requiredFields = form.querySelectorAll('[required]');
                let isValid = true;

                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        isValid = false;
                        field.style.borderColor = 'var(--error-red)';
                        field.focus();
                    } else {
                        field.style.borderColor = '#e2e8f0';
                    }
                });

                if (!isValid) {
                    e.preventDefault();
                    submitBtn.classList.remove('loading');
                    submitBtn.disabled = false;
                    showNotification('error', "{{ 'ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ù…ÙˆÙˆ Ø®Ø§Ù†Û• Ù¾ÛÙˆÛŒØ³ØªÛ•Ú©Ø§Ù† Ù¾Ú•Ø¨Ú©Û•Ø±Û•ÙˆÛ•' if lang == 'ckb' else 'Please fill all required fields' }}");
                }
            });

            // Auto-save functionality (optional)
            let autoSaveTimer;
            const autoSaveInputs = form.querySelectorAll('input, textarea');

            autoSaveInputs.forEach(input => {
                input.addEventListener('input', function() {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(() => {
                        saveToLocalStorage();
                    }, 2000);
                });
            });

            // Save form data to localStorage
            function saveToLocalStorage() {
                const formData = new FormData(form);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }
                localStorage.setItem('slideFormData', JSON.stringify(data));
                showNotification('info', "{{ 'Ø¯Ø§ØªØ§ Ø¨Û• Ø´ÛÙˆÛ•ÛŒ Ø¦Û†ØªÛ†Ù…Ø§ØªÛŒÚ© Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ú©Ø±Ø§' if lang == 'ckb' else 'Data auto-saved' }}", 2000);
            }

            // Load form data from localStorage
            function loadFromLocalStorage() {
                const saved = localStorage.getItem('slideFormData');
                if (saved) {
                    const data = JSON.parse(saved);
                    for (let [key, value] of Object.entries(data)) {
                        const field = form.querySelector(`[name="${key}"]`);
                        if (field && !field.value) { // Only fill if field is empty
                            field.value = value;
                        }
                    }
                }
            }

            // Clear localStorage on successful submit
            form.addEventListener('submit', function() {
                setTimeout(() => {
                    localStorage.removeItem('slideFormData');
                }, 1000);
            });

            // Load saved data if form is empty
            {% if not slide %}
            loadFromLocalStorage();
            {% endif %}

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + S to save
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    form.submit();
                }

                // Ctrl/Cmd + Shift + S for auto-save
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'S') {
                    e.preventDefault();
                    saveToLocalStorage();
                }

                // Escape to cancel
                if (e.key === 'Escape') {
                    const cancelBtn = document.querySelector('.btn-secondary');
                    if (cancelBtn && confirm("{{ 'Ø¯ÚµÙ†ÛŒØ§ÛŒØª Ù„Û• Ù¾Ø§Ø´Ú¯Û•Ø²Ø¨ÙˆÙˆÙ†Û•ÙˆÛ•ØŸ' if lang == 'ckb' else 'Are you sure you want to cancel?' }}")) {
                        window.location.href = cancelBtn.href;
                    }
                }
            });

            // Preview functionality
            function createPreview() {
                const previewSection = document.createElement('div');
                previewSection.className = 'preview-section';
                previewSection.innerHTML = `
                    <h3 class="preview-title">
                        <i class="fas fa-eye"></i>
                        {{ 'Ù¾ÛØ´Ø¨ÛŒÙ†ÛŒÙ†' if lang == 'ckb' else 'Preview' }}
                    </h3>
                    <div class="preview-content" id="previewContent">
                        <!-- Preview will be generated here -->
                    </div>
                `;

                form.parentNode.insertBefore(previewSection, form.nextSibling);
                updatePreview();

                // Update preview on input
                autoSaveInputs.forEach(input => {
                    input.addEventListener('input', updatePreview);
                });
            }

            function updatePreview() {
                const previewContent = document.getElementById('previewContent');
                if (!previewContent) return;

                const titleEn = document.getElementById('title_en').value;
                const titleCkb = document.getElementById('title_ckb').value;
                const contentEn = document.getElementById('content_en').value;
                const contentCkb = document.getElementById('content_ckb').value;
                const imageUrl = document.getElementById('image_url').value;
                const location = document.getElementById('location').value;
                const functions = document.getElementById('functions').value;
                const components = document.getElementById('components').value;

                const currentTitle = "{{ lang }}" === 'ckb' ? titleCkb : titleEn;
                const currentContent = "{{ lang }}" === 'ckb' ? contentCkb : contentEn;

                previewContent.innerHTML = `
                    <div style="border-left: 4px solid var(--primary-blue); padding-left: 1rem;">
                        <h3 style="color: var(--dark-text); margin-bottom: 1rem;">${currentTitle || "{{ 'Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†' if lang == 'ckb' else 'Title' }}"}</h3>
                        ${imageUrl ? `<img src="${imageUrl}" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 1rem;" onerror="this.style.display='none'">` : ''}
                        <p style="color: var(--medium-gray); line-height: 1.6; margin-bottom: 1rem;">${currentContent || "{{ 'Ù†Ø§ÙˆÛ•Ú•Û†Ú©' if lang == 'ckb' else 'Content' }}"}</p>
                        ${location || functions || components ? `
                            <div style="background: var(--light-gray); padding: 1rem; border-radius: 8px;">
                                ${location ? `<div style="margin-bottom: 0.5rem;"><strong>ğŸ“ Location:</strong> ${location}</div>` : ''}
                                ${functions ? `<div style="margin-bottom: 0.5rem;"><strong>âš™ï¸ Functions:</strong> ${functions}</div>` : ''}
                                ${components ? `<div><strong>ğŸ§© Components:</strong> ${components}</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // Add preview toggle button
            const previewBtn = document.createElement('button');
            previewBtn.type = 'button';
            previewBtn.className = 'btn btn-secondary';
            previewBtn.style.position = 'fixed';
            previewBtn.style.bottom = '2rem';
            previewBtn.style.right = '2rem';
            previewBtn.style.zIndex = '1000';
            previewBtn.innerHTML = '<i class="fas fa-eye"></i> {{ "Ù¾ÛØ´Ø¨ÛŒÙ†ÛŒÙ†" if lang == "ckb" else "Preview" }}';

            let previewVisible = false;
            previewBtn.addEventListener('click', function() {
                if (previewVisible) {
                    const preview = document.querySelector('.preview-section');
                    if (preview) {
                        preview.remove();
                        previewVisible = false;
                        this.innerHTML = '<i class="fas fa-eye"></i> {{ "Ù¾ÛØ´Ø¨ÛŒÙ†ÛŒÙ†" if lang == "ckb" else "Preview" }}';
                    }
                } else {
                    createPreview();
                    previewVisible = true;
                    this.innerHTML = '<i class="fas fa-eye-slash"></i> {{ "Ø´Ø§Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ù¾ÛØ´Ø¨ÛŒÙ†ÛŒÙ†" if lang == "ckb" else "Hide Preview" }}';
                }
            });

            document.body.appendChild(previewBtn);

            // Auto-hide flash messages
            const flashMessages = document.querySelectorAll('.flash-message');
            flashMessages.forEach(function(message) {
                setTimeout(function() {
                    message.style.opacity = '0';
                    message.style.transform = 'translateX(-100%)';
                    setTimeout(function() {
                        message.remove();
                    }, 300);
                }, 5000);
            });

            // Focus on first input
            const firstInput = form.querySelector('input, textarea, select');
            if (firstInput) {
                firstInput.focus();
            }
        });

        // Show notification function
        function showNotification(type, message, duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `flash-message ${type}`;
            notification.style.position = 'fixed';
            notification.style.top = '2rem';
            notification.style.right = '2rem';
            notification.style.zIndex = '2000';
            notification.style.maxWidth = '400px';
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;

            document.body.appendChild(notification);

            // Auto-remove
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, duration);
        }

        // Warn about unsaved changes
        let formChanged = false;
        const form = document.getElementById('slideForm');
        const inputs = form.querySelectorAll('input, textarea, select');

        inputs.forEach(input => {
            input.addEventListener('change', () => {
                formChanged = true;
            });
        });

        window.addEventListener('beforeunload', function(e) {
            if (formChanged) {
                const message = "{{ 'Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†Øª Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ù†Û•Ú©Ø±Ø§ÙˆÛ•. Ø¯ÚµÙ†ÛŒØ§ÛŒØª Ù„Û• Ø¯Û•Ø±Ú†ÙˆÙˆÙ†ØŸ' if lang == 'ckb' else 'You have unsaved changes. Are you sure you want to leave?' }}";
                e.returnValue = message;
                return message;
            }
        });

        // Remove warning on form submit
        form.addEventListener('submit', () => {
            formChanged = false;
        });
    </script>
</body>
</html>